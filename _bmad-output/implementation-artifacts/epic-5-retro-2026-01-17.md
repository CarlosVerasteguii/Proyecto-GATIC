# Retrospectiva - Épica 5: Lógica de Movimientos y Estados

- Proyecto: GATIC
- Fecha: 2026-01-17
- Epic: 5
- Fuente de tracking: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- Evidencia principal: stories `_bmad-output/implementation-artifacts/5-*.md`

## Participantes

- Carlos (Project Lead)
- Bob (Scrum Master)
- Alice (Product Owner)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Winston (Architect)

## Resumen de la Épica

La Épica 5 entregó el **núcleo de la operación diaria**: movimientos de activos serializados y por cantidad, kardex, y dashboard operativo con métricas en tiempo casi real.

- **Reglas de estado y transiciones**: Validaciones centralizadas con mensajes accionables.
- **Movimientos de activos serializados**: Asignar, prestar, devolver con trazabilidad completa.
- **Movimientos por cantidad**: Salidas/entradas vinculadas a Empleado con nota obligatoria.
- **Kardex**: Historial que combina movimientos operativos + ajustes administrativos.
- **Dashboard**: Métricas operativas con polling visible (~60s) sin WebSockets.

### Métricas (según sprint-status y artefactos)

| Métrica | Valor |
|---------|-------|
| Historias completadas | 6/6 (100%) |
| Tests al inicio de épica | ~177 (post-Epic 4) |
| Tests al cierre de épica | 267+ |
| Nuevos tests agregados | ~90 tests |
| Code reviews con hallazgos | 6/6 corregidos |
| Pint + PHPStan | ✅ Verde |
| Tablas nuevas | 2 (`asset_movements`, `product_quantity_movements`) |
| Actions nuevas | 5 transaccionales |
| Componentes Livewire nuevos | 6 (forms + kardex + dashboard) |

### Historias entregadas

- **5.1** Reglas de estado y transiciones para activos serializados - FR20
- **5.2** Asignar un Activo serializado a un Empleado - FR17
- **5.3** Prestar y devolver un Activo serializado - FR18, FR19
- **5.4** Movimientos por cantidad vinculados a Producto y Empleado - FR21
- **5.5** Kardex/historial para productos por cantidad - FR22
- **5.6** Dashboard mínimo de métricas operativas (polling) - NFR3

## Lo que salió bien (fortalezas)

### 1) Arquitectura base desde Story 5.1

- `AssetStatusTransitions` provee una **fuente única de verdad** para reglas de transición de estados.
- `AssetTransitionException` genera mensajes accionables en español: "Debe desasignarlo primero", "Debe devolverlo primero".
- Stories 5.2 y 5.3 consumieron estas reglas sin duplicar lógica.
- 21 tests unitarios verifican la matriz de transiciones (AC1/AC2 cumplidos).

**Impacto:** Zero duplicación de validaciones; mensajes consistentes; mantenimiento centralizado.

### 2) Patrón transaccional + lockForUpdate consistente

Todas las Actions de movimientos siguen el mismo patrón:

```php
DB::transaction(function () {
    $asset = Asset::query()->lockForUpdate()->findOrFail($id);
    AssetStatusTransitions::assertCanX($asset->status);
    // ... mutar estado, crear movimiento
});
```

- No hay condiciones de carrera (verificado en tests).
- Integridad referencial garantizada.
- Patrón consolidado desde Epic 3 (`ApplyAssetAdjustment`).

**Impacto:** Consistencia transaccional sin excepciones; tests de concurrencia pasan.

### 3) Reutilización masiva del EmployeeCombobox

El componente `EmployeeCombobox` (Epic 4) se reutilizó en **4 formularios** de Epic 5:
- `AssignAssetForm` (5.2)
- `LoanAssetForm` (5.3)
- `ReturnAssetForm` (5.3, fallback cuando no hay holder)
- `QuantityMovementForm` (5.4)

**Impacto:** UX consistente; teclado (↑↓ Enter Esc), búsqueda con debounce, estados claros (loading/error/no-results); sin reinventar ruedas.

### 4) Inventario dual respetado

- Stories 5.1-5.3: solo activos serializados.
- Stories 5.4-5.5: solo productos por cantidad.
- Kardex (5.5) combina movimientos + ajustes sin romper compatibilidad.
- Helper `LockQuantityProduct` compartido entre ajustes (Epic 3) y movimientos (Epic 5).

**Impacto:** No hay contaminación entre serializados y cantidad; arquitectura limpia.

### 5) Code reviews adversariales salvaron el proyecto

Hallazgos HIGH capturados y corregidos antes de `done`:

- **Story 5.2**: FKs con `cascadeOnDelete()` en `asset_movements` → pérdida de historial si se borra empleado. **Fix:** `restrictOnDelete()`.
- **Story 5.4**: Mismo error en `product_quantity_movements`. **Fix:** `restrictOnDelete()`.
- **Story 5.5**: Merge del kardex explotaba en runtime (`Eloquent\Collection` + arrays). **Fix:** convertir a `Collection` base antes del merge.
- **Story 5.5**: Tests no deterministas (`created_at` ignorado). **Fix:** `Carbon::setTestNow()`.

**Impacto:** Errores críticos capturados antes de producción; proceso de review funciona.

### 6) Dashboard con polling visible sin WebSockets

- Métricas operativas actualizadas cada ~60s con `wire:poll.visible`.
- Intervalo configurable: `config('gatic.ui.polling.metrics_interval_s')`.
- Indicador de frescura: "Actualizado hace Xs" con `<x-ui.freshness-indicator>`.
- Sin introducir Redis/WebSockets/Pusher (regla cumplida).

**Impacto:** Dashboard operativo real; métricas accionables (prestados, pendientes de retiro, movimientos hoy); UX sin distracciones.

## Desafíos (áreas de mejora)

### 1) Action Items de retros previas SIGUEN pendientes

Seguimiento de compromisos de Epic 4:

| # | Action Item | Estado |
|---|-------------|--------|
| 1 | Normalizar "Epic source of truth" para workflows | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 2 | Definir y registrar aceptación (PO) por épica | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 3 | Consolidar helpers/scopes para conteos de disponibilidad | ⚠️ **PARCIAL** (`LockQuantityProduct` creado, pero scopes no) |
| 4 | Estandarizar asserts de tests para UI | ✅ **CUMPLIDO** |
| 5 | Extraer traits/middleware para guardrails comunes | ❌ **PENDIENTE** |

**Impacto:** Deuda de proceso acumulada; Action Items #1 y #2 llevan 3 épicas pendientes.

### 2) Tests requieren Docker/Sail obligatorio

- PHP nativo en máquina es 8.0.x; repo requiere 8.2+.
- Todos los tests de Epic 5 se corrieron en contenedor Sail.
- Fricción para desarrollo local (levantar Sail para cada test run).

**Impacto:** Desarrollo más lento; pero garantiza ambiente consistente.

**Decisión:** Documentar en README que tests requieren Sail obligatoriamente.

### 3) Factories llegaron tarde (Story 5.6)

- No teníamos factories para `Category`, `Brand`, `Location`, `Product`, `Employee`, `Asset`, etc.
- Tests de Epic 1-5 usaban creación manual de datos (menos legibles, más frágiles).
- Story 5.6 creó **8 factories** de golpe para habilitar tests del dashboard.

**Impacto:** Tests menos mantenibles; deuda técnica pagada tarde; debería haberse hecho en Epic 1-2.

### 4) Complejidad del kardex (Story 5.5)

- Combinar dos fuentes de datos (movimientos + ajustes) con orden cronológico determinista no era trivial.
- Bugs en implementación inicial:
  - Merge explotaba por type mismatch (`Eloquent\Collection` vs arrays).
  - Paginador usaba `page` (pisaba parámetro del listado padre).
  - Tests no deterministas (`created_at` ignorado en mass assignment).

**Impacto:** Story 5.5 fue más compleja de lo estimado; requirió múltiples iteraciones de review.

**Lección:** Kardex/historiales que combinan múltiples fuentes necesitan diseño explícito antes de codear.

### 5) Estado "Pendiente de Retiro" sin flujo claro

- Estado `Pendiente de Retiro` existe en `Asset::STATUSES`.
- Reglas de transición en `AssetStatusTransitions` lo bloquean en movimientos normales.
- **No hay story ni flujo UI** para setearlo (solo ajustes Admin).

**Impacto:** Gap funcional; sin definir si es "solo ajustes" o si requiere story futura.

## Patrones y lecciones (sintetizado desde Stories 5.1–5.6)

### Patrones recurrentes (buenos)

1. **Reglas centralizadas de estado** (`AssetStatusTransitions`) - fuente única de verdad; mensajes accionables; zero duplicación.
2. **Actions transaccionales con lockForUpdate** - consistencia sin excepciones; tests de concurrencia.
3. **Componentes Livewire reusables** (`EmployeeCombobox`) - UX consistente; sin reinventar.
4. **Code reviews adversariales** - capturan errores HIGH/MEDIUM antes de producción.
5. **Helpers compartidos** (`LockQuantityProduct`) - evitan duplicación entre módulos.
6. **Tests feature por flujo** - RBAC + happy path + validaciones + edge cases.
7. **Freshness indicators** - UX de polling sin distracciones; confianza en near-real-time.
8. **Mensajes accionables** - "Debe desasignarlo primero" > "Invalid transition".

### Anti-patrones (evitar)

1. ❌ **FKs con cascadeOnDelete en tablas de trazabilidad** - pérdida de historial; usar `restrictOnDelete()`.
2. ❌ **Tests sin factories** - difícil de mantener y leer; crear factories en Epic 1-2.
3. ❌ **Hardcodear intervalos de polling** - usar config centralizada (`config('gatic.ui.polling.*')`).
4. ❌ **Merge de collections sin type-safety** - explosiones en runtime; convertir a tipo base antes de merge.
5. ❌ **Tests no deterministas** - usar `Carbon::setTestNow()` para congelar tiempo.
6. ❌ **Paginadores con nombres genéricos** - `page` pisa contexto del listado padre; usar nombres específicos (`kardex_page`).

### Aprendizajes clave

1. **Arquitectura antes que implementación**: Story 5.1 fue pura arquitectura (sin UI); pagó TODO el epic.
2. **Patrón transaccional es no-negociable**: `DB::transaction()` + `lockForUpdate()` en TODAS las mutaciones críticas.
3. **Reutilización de componentes UX reduce fricción**: `EmployeeCombobox` en 4 lugares sin reinventar.
4. **Kardex/historiales necesitan diseño explícito**: No subestimar complejidad de combinar múltiples fuentes con orden cronológico.
5. **Factories deberían crearse temprano**: Epic 1-2 es el momento correcto; pagarlas tarde genera deuda técnica.

## Seguimiento de retrospectiva anterior (Épica 4)

Se revisaron compromisos de la retrospectiva de Épica 4 (`_bmad-output/implementation-artifacts/epic-4-retro-2026-01-14.md`):

| # | Action Item | Estado |
|---|-------------|--------|
| 1 | Normalizar "Epic source of truth" para workflows | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 2 | Definir y registrar aceptación (PO) por épica | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 3 | Consolidar helpers/scopes para conteos de disponibilidad | ⚠️ **PARCIAL** (`LockQuantityProduct` creado; scopes de `Asset::notAvailable()` pendientes) |
| 4 | Estandarizar asserts de tests para UI | ✅ **CUMPLIDO** (tests de Epic 5 usan `assertSeeText`, `data-testid`, Livewire asserts) |
| 5 | Extraer traits/middleware para guardrails comunes | ❌ **PENDIENTE** |

## Preparación para la próxima épica (Épica 6: Búsqueda y filtros)

Según `sprint-status.yaml` y `epics.md`, la Épica 6 cubre:

- **6.1** Búsqueda unificada (productos + activos) con salto directo por match exacto
- **6.2** Filtros de inventario por catálogos y estado/disponibilidad

### Dependencias claras desde Épica 5

- ✅ Movimientos operativos funcionando (asignar, prestar, devolver, cantidad).
- ✅ Kardex de productos por cantidad operativo.
- ✅ Dashboard con métricas operativas.
- ✅ Estados de activos consolidados (`AssetStatusTransitions`).

### Riesgos a anticipar para Épica 6

1. **Scopes de disponibilidad pendientes (Action Item #3)**: Filtros de inventario requieren scopes como `Asset::notAvailable()`, `Product::lowStock()`. Si no están, cada componente duplicará lógica.
2. **Búsqueda unificada puede ser costosa**: Queries sobre `products` + `assets` sin índices adecuados.
3. **Factories faltantes (Action Item #3)**: Tests de búsqueda/filtros serán frágiles sin factories.

### Bloqueantes confirmados para Épica 6

- **Action Item #3** (scopes de disponibilidad) - **BLOQUEANTE** para Story 6.2.
- **Action Item #3** (factories) - **BLOQUEANTE** para calidad de tests de Epic 6.

## Action Items (compromisos)

### Proceso (alta prioridad)

1. **Normalizar el "Epic source of truth" para workflows** (arrastre desde Epic 2)
   - Owner: Bob (Scrum Master) + Paige (Technical Writer)
   - Deadline: **Antes de iniciar Epic 6**
   - Criterio de éxito: workflow encuentra epic actual/siguiente sin rutas manuales
   - **Escalation:** Si no se cumple, Carlos (Project Lead) toma ownership

2. **Implementar aceptación (PO) por épica** (arrastre desde Epic 2)
   - Owner: Alice (Product Owner) + Carlos (Project Lead)
   - Deadline: **Antes de marcar Epic 6 como `done`**
   - Criterio de éxito: bloque de sign-off en artefacto de épica
   - **Escalation:** Carlos lo hace manualmente si Alice no lo define

### Técnico (deuda - BLOQUEANTES para Epic 6)

3. **Crear factories faltantes en Epic 1-4** (deuda de Epic 5.6)
   - Owner: Dana (QA Engineer) + Elena (Junior Dev)
   - Deadline: **Antes de iniciar Epic 6**
   - Criterio de éxito: factories para todos los modelos core; refactorizar tests existentes que usan creación manual
   - **Escalation:** Si bloquea Epic 6, Charlie (Senior Dev) toma ownership

4. **Consolidar scopes/helpers para conteos de disponibilidad** (Epic 3, parcialmente cumplido)
   - Owner: Charlie (Senior Dev) + Winston (Architect)
   - Deadline: **Antes de iniciar Story 6.1**
   - Criterio de éxito: scopes `Asset::notAvailable()`, `Asset::available()`, `Product::lowStock()` documentados y testeados
   - **Escalation:** Winston lo hace si Charlie no puede

### Producto

5. **Documentar flujo de "Pendiente de Retiro"**
   - Owner: Alice (Product Owner) + Winston (Architect)
   - Deadline: **Antes de Epic 6**
   - Criterio de éxito: decisión documentada (solo ajustes Admin vs story futura con UI dedicada)
   - **Escalation:** N/A (Alice es la única que puede decidir)

6. **Definir roadmap de auditoría/trazabilidad post-Epic 8**
   - Owner: Alice (Product Owner)
   - Deadline: **Durante Epic 6**
   - Criterio de éxito: documento con casos de uso de auditoría (legal, operativo, debug)
   - **Escalation:** Carlos revisa si no hay avance en 2 semanas

## Ruta crítica (antes de iniciar Épica 6)

1. ✅ Epic 5 marcado como `done`
2. ⚠️ **Action Item #3** (factories) → BLOQUEANTE
3. ⚠️ **Action Item #4** (scopes de disponibilidad) → BLOQUEANTE
4. ⚠️ **Action Item #1** (epic source of truth) → PROCESO
5. ⚠️ **Action Item #5** (flujo "Pendiente de Retiro") → PRODUCTO

## Readiness Assessment (Épica 5)

| Área | Estado |
|------|--------|
| Testing & Quality | ✅ Suite de 267+ tests passing; Pint + PHPStan en verde |
| Deployment | ⚠️ No trazado en artefactos (pendiente desde Épica 3) |
| Stakeholder/PO Acceptance | ⚠️ No hay sign-off formal (Action Item #2) |
| Salud técnica | ✅ Arquitectura sólida; patrones consolidados; deuda técnica controlada |
| Preparación para Epic 6 | ⚠️ Requiere completar Action Items #3 y #4 ANTES de iniciar |

## Cierre

La Épica 5 entrega el **núcleo operativo** del sistema: movimientos de activos serializados y por cantidad, kardex, y dashboard con métricas en tiempo casi real. Sin Epic 5, GATIC sería un Excel glorificado. Con Epic 5, es una herramienta operativa real.

### Fortalezas principales

- Arquitectura de reglas de estado centralizada (`AssetStatusTransitions`).
- Patrón transaccional + lockForUpdate sin excepciones.
- Reutilización masiva de componentes (`EmployeeCombobox`).
- Code reviews adversariales salvaron errores críticos (FKs con cascadeOnDelete, merge de kardex).
- Dashboard operativo con polling visible sin WebSockets.

### Deuda y pendientes

- Action Items de Epic 2/3/4 siguen pendientes (3 de 5).
- Factories llegaron tarde (Epic 5.6); deberían haberse creado en Epic 1-2.
- Flujo de "Pendiente de Retiro" sin definir.
- Tests requieren Sail obligatorio (PHP 8.2+).

### Condiciones para Epic 6

Epic 5 se marca como **DONE** con las siguientes condiciones:
- **Action Item #3** (factories) debe completarse ANTES de Epic 6.
- **Action Item #4** (scopes de disponibilidad) debe completarse ANTES de Story 6.1.
- Action Items #1, #2, #5, #6 no son bloqueantes pero deben escalarse si no se cumplen.

**Próximo paso:** Completar ruta crítica (factories + scopes) antes de iniciar Epic 6.

---

**Fecha de cierre:** 2026-01-17  
**Facilitador:** Bob (Scrum Master)  
**Aprobación:** Carlos (Project Lead)
