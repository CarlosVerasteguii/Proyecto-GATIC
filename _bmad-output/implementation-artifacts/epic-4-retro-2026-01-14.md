# Retrospectiva - Épica 4: Directorio de Empleados (RPE)

- Proyecto: GATIC
- Fecha: 2026-01-14
- Epic: 4
- Fuente de tracking: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- Evidencia principal: stories `_bmad-output/implementation-artifacts/4-*.md`

## Participantes

- Carlos (Project Lead)
- Bob (Scrum Master)
- Alice (Product Owner)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Winston (Architect)

## Resumen de la Épica

La Épica 4 entregó el **Directorio de Empleados (RPE)** como base para la operación diaria de movimientos:

- **CRUD de Empleados**: Alta/edición con validaciones (RPE único, campos mínimos).
- **Autocomplete reusable**: Selector de Empleado con búsqueda por RPE/nombre, teclado (↑↓ Enter Esc), estados loading/error/no-results.
- **Ficha de Empleado**: Vista de detalle con secciones preparadas para activos (vacías hasta Epic 5).
- **Patrones consolidados**: Actions reusables (`SearchEmployees`), RBAC en profundidad, Alpine.js para UX de teclado.

### Métricas (según sprint-status)

| Métrica | Valor |
|---------|-------|
| Historias completadas | 3/3 (100%) |
| Tests al inicio de épica | ~152 |
| Tests al cierre de épica | 177+ |
| Code reviews con hallazgos | 3/3 corregidos |
| Pint + PHPStan | ✅ Verde |

### Historias entregadas

- **4.1** Crear y mantener Empleados (RPE) - FR15
- **4.2** Buscar/seleccionar Empleados al registrar movimientos (autocomplete) - FR16
- **4.3** Ficha de Empleado (detalle) y activos asociados (si existen) - FR15

## Lo que salió bien (fortalezas)

### 1) Épica compacta y enfocada

- Solo 3 historias bien definidas que entregan valor incremental.
- El alcance se respetó: no se adelantó lógica de movimientos (Epic 5).
- Las secciones "Activos asignados/prestados" se dejaron vacías con placeholder explícito ("Se habilita con Movimientos").

### 2) Reuso efectivo de patrones de épicas anteriores

- **Patrón CRUD Livewire**: Story 4.1 reutilizó la estructura de `BrandsIndex`/`LocationsIndex` (Epic 2) sin reinventar.
- **Escape LIKE + normalización**: El autocomplete (Story 4.2) reutilizó `Employee::normalizeText()` y el patrón `escapeLike()` existente.
- **RBAC en profundidad**: Gate `inventory.manage` aplicado consistentemente en rutas + componentes Livewire.

### 3) Actions reusables para lógica crítica

- `SearchEmployees` encapsula búsqueda con relevancia (prefijo primero, fallback contains), escape de wildcards, y límite configurable.
- Esto prepara Epic 5: el autocomplete ya está listo para usarse en formularios de movimientos.

### 4) UX de autocomplete con teclado y accesibilidad

- Alpine.js para navegación con flechas sin disparar requests por cada keypress.
- ARIA: `role="combobox"`, `aria-activedescendant`, `aria-selected`.
- Estados claros: loading, no-results, error con retry.

### 5) Code review adversarial sigue pagando

- Los 3 stories pasaron por revisión AI con hallazgos HIGH/MEDIUM corregidos antes de `done`.
- Ejemplos de hallazgos reales corregidos:
  - Extraer búsqueda a Action reusable (no inline en componente).
  - Sync de `employeeId` → `employeeLabel` cuando cambia desde el padre.
  - Mejoras ARIA para accesibilidad.

## Desafíos (áreas de mejora)

### 1) Action Items de retros anteriores siguen pendientes

- **"Epic source of truth" para workflows** (arrastre desde Épica 2): el workflow sigue dependiendo de rutas manuales.
- **Aceptación PO por épica** (arrastre desde Épica 2): no hay sign-off formal en artefactos.

### 2) Helpers de conteos no se consolidaron

- El Action Item #3 de Épica 3 ("Consolidar helpers/scopes para conteos de disponibilidad") quedó pendiente.
- Story 4.3 no los requirió (secciones vacías), pero Epic 5 sí los necesitará.

### 3) Traits/middleware para guardrails comunes pendientes

- El Action Item #5 de Épica 3 ("Extraer traits/middleware para guardrails comunes") no se completó.
- En Epic 5 será crítico: validaciones como "activo debe estar Disponible para asignar" se repetirán en múltiples componentes.

### 4) PHP local < 8.2 bloqueó validación de tests en algunas máquinas

- Los tests se corrieron en Sail/CI, pero el flujo local se vio afectado.
- No es bloqueante, pero genera fricción.

## Patrones y lecciones (sintetizado desde Stories 4.1–4.3)

### Patrones recurrentes (buenos)

- **Livewire + Alpine.js para UX compleja**: El combo funciona bien para interacciones de teclado sin sobrecarga de requests.
- **#[Modelable] en componentes reusables**: Permite `wire:model` desde el padre sin props manuales.
- **Actions para lógica de negocio**: Separar búsqueda/validación de la UI facilita tests y reuso.
- **Estados vacíos explícitos**: Mostrar "N/A" o "Se habilita en Epic X" evita confusión y fuerza el scope correcto.

### Aprendizajes clave

1. **El autocomplete es más complejo de lo que parece**: Requiere debounce, escape, teclado, ARIA, estados de error, sync bidireccional. Hacerlo bien desde el inicio ahorra retrabajo.
2. **Épicas pequeñas y enfocadas reducen riesgo**: 3 stories bien definidas permitieron entregar sin scope creep.
3. **Preparar "placeholders" para funcionalidad futura**: Las secciones vacías en la ficha de empleado documentan la dependencia sin introducir código muerto.

## Seguimiento de retrospectiva anterior (Épica 3)

Se revisaron compromisos de la retrospectiva de Épica 3 (`_bmad-output/implementation-artifacts/epic-3-retro-2026-01-14.md`):

| # | Action Item | Estado |
|---|-------------|--------|
| 1 | Normalizar "Epic source of truth" para workflows | ❌ **Pendiente** (arrastre desde Épica 2) |
| 2 | Definir y registrar aceptación (PO) por épica | ❌ **Pendiente** (arrastre desde Épica 2) |
| 3 | Consolidar helpers/scopes para conteos de disponibilidad | ⚠️ **Pendiente** (no requerido en Epic 4; crítico para Epic 5) |
| 4 | Estandarizar asserts de tests para UI | ✅ **Cumplido parcial** (nuevos tests de Epic 4 usan `assertSeeText` y Livewire asserts) |
| 5 | Extraer traits/middleware para guardrails comunes | ❌ **Pendiente** (crítico para Epic 5) |
| 6 | Definir reglas de unicidad y campos mínimos para Empleados (RPE) | ✅ **Cumplido** (RPE único, campos documentados en Story 4.1) |

## Preparación para la próxima épica (Épica 5: Operación diaria de movimientos)

Según `sprint-status.yaml` y `epics.md`, la Épica 5 cubre:

- **5.1** Reglas de estado y transiciones para activos serializados (FR20)
- **5.2** Asignar un Activo serializado a un Empleado (FR17)
- **5.3** Prestar y devolver un Activo serializado (FR18, FR19)
- **5.4** Movimientos por cantidad vinculados a Producto y Empleado (FR21)
- **5.5** Kardex/historial para productos por cantidad (FR22)
- **5.6** Dashboard mínimo de métricas operativas (polling)

### Dependencias claras desde Épica 4

- ✅ Módulo de Empleados operativo (CRUD + autocomplete + ficha).
- ✅ `EmployeeCombobox` listo para integrarse en formularios de movimientos.
- ✅ Patrones de RBAC, Actions, y UI consolidados.

### Riesgos a anticipar para Épica 5

1. **Complejidad de transiciones de estado**: Activo puede estar en múltiples estados (Disponible, Asignado, Prestado, Pendiente de Retiro, Retirado). Las reglas de transición deben ser claras y testeadas.
2. **Validaciones repetitivas sin traits/middleware**: Sin el Action Item #5, cada componente repetirá lógica como "activo debe estar Disponible".
3. **Tenencia actual vs historial**: Definir si la tenencia es un campo en `assets` o una tabla separada de movimientos.
4. **Kardex para cantidad**: Requiere diseño de tabla de movimientos y cálculo de stock actual.

### Tareas de preparación propuestas (Épica 5)

- [ ] **Completar Action Item #3**: Consolidar helpers/scopes para conteos de disponibilidad  
  Owner: Charlie (Senior Dev) + Winston (Architect)

- [ ] **Completar Action Item #5**: Extraer traits/middleware para guardrails comunes  
  Owner: Winston (Architect)

- [ ] **Diseñar estructura de movimientos**: Definir si `current_holder_id` vive en `assets` o si todo se deriva de tabla `movements`  
  Owner: Winston (Architect) + Alice (Product Owner)

- [ ] **Documentar reglas de transición de estados**: Diagrama de estados y transiciones válidas  
  Owner: Alice (Product Owner) + Charlie (Senior Dev)

- [ ] **Definir mínimo viable de Kardex**: Qué campos/filtros son necesarios para FR22  
  Owner: Alice (Product Owner)

## Action Items (compromisos)

### Proceso

1. **Normalizar el "Epic source of truth" para workflows** (arrastre desde Épica 2)
   - Owner: Bob (Scrum Master) + Paige (Technical Writer)
   - Deadline: Antes del siguiente workflow de retrospectiva
   - Criterio de éxito: el workflow encuentra el epic actual/siguiente sin rutas manuales

2. **Implementar aceptación (PO) por épica** (arrastre desde Épica 2)
   - Owner: Alice (Product Owner) + Carlos (Project Lead)
   - Deadline: Antes de marcar Épica 5 como `done`
   - Criterio de éxito: bloque de sign-off en artefacto de épica

### Técnico

3. **Consolidar helpers/scopes para conteos de disponibilidad** (arrastre desde Épica 3)
   - Owner: Charlie (Senior Dev) + Winston (Architect)
   - Deadline: Antes de iniciar Story 5.2 (asignar activo)
   - Criterio de éxito: un único scope/método para conteos, usado en listados y formularios

4. **Extraer traits/middleware para guardrails comunes** (arrastre desde Épica 3)
   - Owner: Winston (Architect)
   - Deadline: Antes de iniciar Épica 5
   - Criterio de éxito: "activo debe estar Disponible" y "activo pertenece al producto" son traits reutilizables

5. **Diseñar y documentar estructura de movimientos/tenencia**
   - Owner: Winston (Architect) + Alice (Product Owner)
   - Deadline: Antes de crear Story 5.1 "ready-for-dev"
   - Criterio de éxito: decisión documentada en architecture.md o artefacto dedicado

### Producto / Operación

6. **Documentar diagrama de estados y transiciones para activos**
   - Owner: Alice (Product Owner) + Charlie (Senior Dev)
   - Deadline: Antes de crear Story 5.1 "ready-for-dev"
   - Criterio de éxito: diagrama visual + reglas textuales en artefacto

## Ruta crítica (antes de iniciar Épica 5)

1. Diseño de movimientos/tenencia definido (Action Item #5)
2. Diagrama de transiciones de estados documentado (Action Item #6)
3. Guardrails comunes extraídos (Action Item #4)
4. Helpers de conteos consolidados (Action Item #3)

## Readiness Assessment (Épica 4)

| Área | Estado |
|------|--------|
| Testing & Quality | ✅ Suite de 177+ tests passing; Pint + PHPStan en verde |
| Deployment | ⚠️ No trazado en artefactos (pendiente desde Épica 3) |
| Stakeholder/PO Acceptance | ⚠️ No hay sign-off formal (Action Item #2) |
| Salud técnica | ✅ Base sólida; patrones consolidados; sin deuda crítica conocida |
| Preparación para Epic 5 | ⚠️ Requiere completar ruta crítica antes de iniciar |

## Cierre

La Épica 4 entrega un módulo de Empleados completo y listo para integrarse con los movimientos de la Épica 5. El `EmployeeCombobox` es el activo más valioso: un componente reusable con UX de calidad (teclado, accesibilidad, estados claros) que reduce la fricción de "registrar un movimiento".

Los principales pendientes son **deuda de proceso** (normalizar epic source of truth, sign-off de PO) y **preparación técnica** (guardrails comunes, diseño de movimientos). La épica fue compacta y enfocada, lo que permitió entregarla sin scope creep.

**Próximo paso:** Completar la ruta crítica de Action Items antes de iniciar Épica 5.
