# Retrospectiva - Épica 8: Trazabilidad y evidencia (auditoría, notas, adjuntos, papelera, errores)

- Proyecto: GATIC
- Fecha: 2026-01-25
- Epic: 8
- Fuente de tracking: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- Evidencia principal: stories `_bmad-output/implementation-artifacts/8-*.md`
- Retro anterior integrada: `_bmad-output/implementation-artifacts/epic-7-retro-2026-01-23.md`

## Participantes

- Carlos (Project Lead)
- Bob (Scrum Master)
- Alice (Product Owner)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Winston (Architect)

## Resumen de la Épica

La Épica 8 completó el **Gate 5 (Trazabilidad y evidencia)** agregando capacidades transversales de **gobernanza y soporte**:

- **Auditoría consultable** (best-effort, no bloqueante) con filtros y detalle.
- **Notas manuales** en entidades clave con RBAC server-side y auditoría de creación.
- **Adjuntos seguros** en storage privado, con control de acceso estricto y auditoría.
- **Papelera** (soft-delete/restaurar/purgar) con manejo seguro de FKs y UX defensiva.
- **Soporte por `error_id`**: lookup Admin con detalle técnico y flujo end-to-end consistente.

### Historias entregadas

- **8.1** Auditoría consultable (best-effort) — FR32
- **8.2** Notas manuales en entidades relevantes — FR33
- **8.3** Adjuntos seguros con control de acceso — FR34
- **8.4** Papelera (soft-delete / restaurar / purgar) — FR35
- **8.5** Error ID consultable por Admin (end-to-end) — FR36

### Métricas (según sprint-status y artefactos)

| Métrica | Valor |
|---------|-------|
| Historias completadas | 5/5 (100%) |
| Suite de tests (referencias internas) | 443 (Story 8.1) → 531 (Story 8.3) → 552 (Story 8.4) |
| Migraciones nuevas | 4 (`audit_logs`, `notes`, `attachments`, `employees.deleted_at`) |
| Livewire components nuevos | 4 (`Admin\\Audit\\AuditLogsIndex`, `Ui\\NotesPanel`, `Ui\\AttachmentsPanel`, `Admin\\Trash\\TrashIndex`) |
| Jobs nuevos | 1 (`RecordAuditLog` best-effort) |
| Controllers “borde” nuevos | 1 (`DownloadAttachmentController`) |
| Calidad | Pint ✅; Larastan: 1 error pre-existente reportado (NotesPanel) |

## Patrones detectados (análisis de stories)

### Patrones recurrentes (5/5 stories)

1) **RBAC defensa en profundidad (server-side)**
   - Route middleware `can:*` + `Gate::authorize(...)` en Livewire y/o acciones críticas.
   - UI “no muestra” ≠ seguridad; siempre se reforzó en servidor.

2) **Trazabilidad sin bloquear operación (best-effort)**
   - Auditoría y logging se diseñaron para **NO romper flujos** si fallan (swallow/log + continuidad).
   - Reforzado con tests y allowlist/truncado de `context` para evitar PII/secretos.

3) **UX defensiva para acciones riesgosas**
   - Confirmaciones para acciones destructivas (purga/vaciar/borrar adjuntos).
   - `long-request` cuando aplica, mensajes seguros y consistentes, sin filtrar excepciones crudas.

### Patrones de code review (5/5 stories)

- Se corrigieron edge cases antes de consolidar `done`:
  - limpieza best-effort de archivos huérfanos (upload) si falla DB,
  - manejo seguro de FKs `restrict` en purga,
  - paginación aislada para panel reusable (evitar colisiones),
  - validación server-side de “tipos permitidos” en módulos Admin,
  - mejoras de observabilidad (auditoría con `attachment_id`, y mensajes con `error_id` donde aplica).

## Lo que salió bien (fortalezas)

### 1) Gate 5 completo con módulos transversales reutilizables

- `AuditRecorder` + `RecordAuditLog` creó un “camino feliz” estándar para auditoría.
- `NotesPanel` y `AttachmentsPanel` consolidaron un patrón UI reusable en detalles (Product/Asset/Employee).
- La **Papelera** se alineó con reglas críticas (retención indefinida; purga solo por Admin).

**Impacto:** el sistema ahora soporta investigación operativa (auditoría/error_id) y evidencia documental (notas/adjuntos) sin sacrificar seguridad.

### 2) Calidad y seguridad reforzadas por tests y revisiones adversariales

- Cada story cerró con correcciones concretas de HIGH/MEDIUM (sin culpas, con aprendizaje).
- Se reforzó “no filtrar secretos” (allowlist) en auditoría y errores.

**Impacto:** menor riesgo de regresiones y menor riesgo de exposición de datos sensibles.

### 3) Soft-delete y purga tratados como problema de integridad (no solo UI)

- Restore/purge consideró dependencias reales (FKs y visibilidad).
- Se evitó el patrón peligroso “forceDelete a ciegas” y se devolvió feedback claro.

**Impacto:** operaciones seguras para Admin sin romper la base de datos ni generar 500s.

## Lo que no salió tan bien (o costó más de lo esperado)

1) **Complejidad de features cross-cutting**
   - Auditoría, adjuntos, papelera y errores tocan múltiples capas (DB, UX, RBAC, jobs, storage, tests).
   - El costo real estuvo en los bordes: seguridad, limpieza/consistencia y regresión.

2) **Deuda/ruido de herramientas**
   - Larastan reportó 1 error pre-existente (NotesPanel) que quedó como arrastre.

3) **Falta de “runbook” operativo**
   - Gate 5 introduce flujos de soporte (auditoría/error_id/papelera) que conviene documentar para operación real (qué hacer, qué esperar, qué no esperar).

## Continuidad desde la retrospectiva de Épica 7 (follow-through)

En Épica 7 se comprometieron 8 action items. Este fue el estado observado al cerrar Épica 8:

| Action item (Épica 7) | Estado en Épica 8 | Evidencia / Nota |
|---|---|---|
| 1) Proceso PO sign-off | ✅ Completado | Se formalizó como parte de “docs(bmad): sign-off/preflight”. |
| 2) Checklist dev pre-flight | ✅ Completado | Reutilizado como fuente explícita en stories (p.ej. dev-preflight, long-request, tests deterministas). |
| 3) Diagramas de estado (entidades) | ❌ No abordado | Sigue pendiente; no apareció como deliverable en stories 8.x. |
| 4) Documentar patrón de locks | ❌ No abordado | Sigue pendiente; no hay evidencia nueva en 8.x. |
| 5) Consolidar scopes/helpers disponibilidad | ⏳ En progreso (arrastre) | No se observó avance explícito en 8.x. |
| 6) Factories faltantes Epic 1–4 | ⏳ En progreso (arrastre) | Epic 8 agregó factories nuevas (Notes/Attachments), pero no completa el backlog histórico. |
| 7) Flujo “Pendiente de Retiro” | ❌ No abordado | Sigue pendiente. |
| 8) Casos de uso de auditoría | ✅ Completado | Se usó como “bible” para scope/allowlist de auditoría (Story 8.1). |

**Lectura del equipo:** cuando hubo “bibles” y checklists claros, se notó la mejora en consistencia (menos re-trabajo por seguridad/UX).

## Action Items / Compromisos (Épica 8)

### Proceso

1. **DoD Gate 5 (cierre de épica) como checklist formal**
   - Owner: Bob (Scrum Master) + Alice (Product Owner)
   - Deadline: Antes de marcar la Épica 8 como `done`
   - Criterio de éxito: checklist usado en el cierre (sign-off PO + validaciones + sprint-status consistente).

2. **Regla “cross-cutting = tests primero”**
   - Owner: Charlie (Senior Dev)
   - Deadline: Inmediato (aplicar desde la próxima story)
   - Criterio de éxito: toda story que toque auditoría/adjuntos/papelera/errores incluye tests Feature/RBAC y caso negativo de seguridad.

### Técnico (deuda / hardening)

3. **Resolver el error de Larastan en `NotesPanel.php` (arrastre)**
   - Owner: Charlie (Senior Dev) + Elena (Junior Dev)
   - Deadline: Antes de iniciar nueva épica
   - Criterio de éxito: Larastan en verde (sin aumentar deuda).

4. **Política de retención + runbook de datos para Gate 5**
   - Owner: Winston (Architect) + Dana (QA Engineer)
   - Deadline: Antes de despliegue/uso real por operación
   - Criterio de éxito: documento con: retención/purga (audit_logs / error_reports / adjuntos), riesgos de crecimiento, y checklist de verificación en entorno real.

5. **Verificación de entorno real para storage privado**
   - Owner: Winston (Architect)
   - Deadline: Antes de “release” o demo operativa
   - Criterio de éxito: confirmación documentada de que descargas de adjuntos funcionan con permisos correctos y sin exposición pública accidental.

### Documentación (operación / soporte)

6. **Guía Admin/Soporte (auditoría + papelera + `error_id`)**
   - Owner: Paige (Tech Writer) + Alice (Product Owner)
   - Deadline: Antes de que el equipo de soporte use Gate 5
   - Criterio de éxito: documento simple de “cómo investigar” con capturas/flujo (qué buscar, dónde, y cómo escalar).

### Acuerdos de equipo

- Toda UI “solo Admin” requiere: link condicional + middleware `can:*` + `Gate::authorize(...)` en Livewire.
- Todo `context` persistido (auditoría/errores) pasa por **allowlist + truncado** (no PII/secretos).
- Toda acción destructiva incluye confirmación explícita + mensajes seguros + manejo de fallos sin 500.
- Soft-delete es “default”: cualquier conteo/listado debe tener test de regresión (soft-deleted no aparece).

## Preparación para la siguiente épica (aún no definida)

- **Definir el siguiente bloque de trabajo (Epic 9 o equivalente)** con alcance claro (p.ej. estabilización + deployment + monitoreo/observabilidad).
  - Owner: Carlos (Project Lead) + Alice (Product Owner)
  - Entregable: épica(s) nuevas en roadmap + stories iniciales priorizadas.

## Vista rápida: siguiente épica (Epic 9)

- **Estado (tracking):** Epic 9 `done` en `_bmad-output/implementation-artifacts/sprint-status.yaml`.
- **Objetivo (resumen):** cerrar pendientes de docs/operación (state machines, locks, conteos, runbook, guía soporte).
- **Evidencia:** `gatic/docs/` + stories `9-*.md` en `_bmad-output/implementation-artifacts/`.
- **Dependencias recomendadas antes de avanzar:** sign-off PO de Épica 8 (si aplica), verificación de entorno real para storage privado.

## Descubrimientos significativos (y recomendaciones)

1) **Gate 5 no termina en “features”: crea superficie operativa**
   - Auditoría, papelera, adjuntos y `error_id` requieren guía de operación y política de retención.
   - **Recomendación:** incluir “operación + hardening Gate 5” explícitamente en la próxima épica/roadmap.

2) **El riesgo principal estuvo en “los bordes” (seguridad/consistencia)**
   - Los fixes recurrentes fueron sobre RBAC server-side, limpieza de storage, FKs, mensajes seguros.
   - **Recomendación:** formalizar un mini-checklist Gate 5 (Action Item #1/#2) como parte del DoD.

## Ruta crítica (antes de avanzar a “siguiente épica”)

1. ✅ Retrospectiva Épica 8 registrada (este documento) y marcada `done` en sprint-status.
2. ⏳ Sign-off PO (demo/aceptación formal) para marcar `epic-8` como `done` (si aplica al proceso).
3. ✅ Definir Epic 9 (o siguiente fase) y su criterio de éxito.
4. ✅ Resolver Larastan (Action Item #3).
5. ✅ Runbook + retención de Gate 5 (Action Item #4).

## Readiness Assessment (Épica 8)

| Área | Estado |
|------|--------|
| Testing & Quality | ✅ Evidencia de suite pasando (refs 443→531→552); Pint OK; PHPStan OK (CI con memory limit) |
| Seguridad/RBAC | ✅ Gates + middleware + validaciones server-side consistentes (audit/notes/attachments/trash/error_id) |
| Operación/Soporte | ✅ Runbook/guía creados. ⚠️ Falta verificación de entorno real (storage privado) |
| Deployment | ⚠️ No trazado en artefactos; confirmar plan de despliegue/configuración para Gate 5 |
| Bloqueos conocidos | ✅ No se registraron bloqueos técnicos abiertos en stories |

## Cierre

La Épica 8 deja al sistema con **trazabilidad y evidencia** aptas para operación: auditoría, notas, adjuntos, papelera y soporte por `error_id`. El aprendizaje principal es que los features cross-cutting se ganan en los bordes: seguridad, higiene de datos, UX defensiva y pruebas.

### Fortalezas principales

- Consistencia RBAC server-side en módulos sensibles.
- Auditoría best-effort con allowlist y tests → buen balance entre trazabilidad y continuidad operativa.
- Papelera/purga segura (integridad primero) con mensajes claros.

### Pendientes clave

- Verificación de entorno real para storage privado (Gate 5).
- Pendientes arrastrados de retros previas (p. ej. “Pendiente de Retiro”, factories históricas).

---

**Fecha de cierre:** 2026-01-25  
**Facilitador:** Bob (Scrum Master)  
**Aprobación:** Carlos (Project Lead)
