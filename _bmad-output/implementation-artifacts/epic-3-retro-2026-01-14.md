# Retrospectiva - Épica 3: Inventario navegable (Productos/Activos) + Ajustes

- Proyecto: GATIC
- Fecha: 2026-01-14
- Epic: 3
- Fuente de tracking: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- Evidencia principal: stories `_bmad-output/implementation-artifacts/3-*.md`

## Participantes

- Carlos (Project Lead)
- Bob (Scrum Master)
- Alice (Product Owner)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Winston (Architect)

## Resumen de la Épica

La Épica 3 entregó el núcleo del módulo de **Inventario Navegable** con enfoque en consulta operativa y trazabilidad base:

- **Productos**: CRUD con tipo derivado por Categoría (serializado vs por cantidad), `qty_total` para stock agregado.
- **Activos serializados**: CRUD con reglas de unicidad (`serial` por Producto, `asset_tag` global).
- **Disponibilidad**: Indicadores en listados y detalles (Total/Disponibles/No disponibles) con semántica QTY consistente.
- **Detalles**: Pantallas de detalle de Producto y Activo con desglose por estado y navegación contextual.
- **Ajustes de inventario**: Admin-only con motivo obligatorio, trazabilidad (before/after), y transacciones atómicas.

### Métricas (según sprint-status)

- Historias completadas: 6/6 (100%)
- Story points / sprints: N/D en artefactos

### Historias entregadas

- 3.1 Crear y mantener Productos (FR8, FR9)
- 3.2 Crear y mantener Activos serializados con reglas de unicidad (FR10, FR11)
- 3.3 Listado de Inventario (Productos) con indicadores de disponibilidad (FR25)
- 3.4 Detalle de Producto con conteos y desglose por estado (FR12)
- 3.5 Detalle de Activo con estado, ubicación y tenencia actual (FR13)
- 3.6 Ajustes de inventario (Admin) con motivo (FR14)

## Lo que salió bien (fortalezas)

### 1) Semántica QTY consolidada y consistente

- Se definió y aplicó la semántica de disponibilidad de forma transversal:
  - `No disponibles` = `Asignado + Prestado + Pendiente de Retiro`
  - `Disponibles` = `Total - No disponibles`
  - `Retirado` no cuenta en inventario baseline
- Constantes centralizadas en `Asset::STATUSES` y `Asset::UNAVAILABLE_STATUSES` reducen drift entre módulos.

### 2) Patrones de arquitectura consolidados

- **Livewire-first**: Rutas → Componentes Livewire → Views (sin Controllers salvo "bordes").
- **Actions transaccionales**: `app/Actions/Inventory/Adjustments/*` para operaciones críticas, con `DB::transaction()`.
- **Autorización en profundidad**: `Gate::authorize(...)` en `mount()`, `render()`, y hooks `updated*()` de Livewire.
- **Rutas con `whereNumber`**: Evitan colisiones y validan inputs numéricos desde el routing.

### 3) Calidad guiada por code review adversarial

- Cada story pasó por revisión AI con hallazgos HIGH/MEDIUM corregidos antes de marcar como `done`.
- Fixes recurrentes documentados (queries en `render()`, tests frágiles, UX de accesibilidad) y corregidos sistemáticamente.
- Suite de tests creciente: 136+ tests feature pasando al cierre de Épica 3.

### 4) UX consistente y accesible

- Resaltes de disponibilidad no dependen solo de color (texto + icono).
- Navegación "Volver" preserva contexto (query string `q`/`page`) en flujos de inventario.
- Toasts y mensajes de éxito/error en español, siguiendo `gatic/docs/ui-patterns.md`.

### 5) Tenencia N/A documentada y respetada

- En Épica 3 no existen Empleados ni Movimientos: la tenencia se muestra como **N/A (se habilita en Épica 4/5)**.
- Esto evitó scope creep y mantuvo la épica enfocada en inventario navegable.

## Desafíos (áreas de mejora)

### 1) Queries complejas en conteos (anti N+1)

- Varias historias requirieron optimización post-implementación para evitar N+1 y subconsultas redundantes.
- Oportunidad: Consolidar helpers/scopes para conteos de disponibilidad en `Product` y `Asset`.

### 2) Tests frágiles por regex sobre HTML

- Algunos tests usaban regex sobre el HTML completo, lo que los hacía sensibles a cambios de markup.
- Oportunidad: Estandarizar asserts con `assertSeeTextInOrder` / `assertSeeText` y data-attributes para elementos clave.

### 3) Guardrails repetidos por story

- Validaciones como "producto serializado requerido" o "activo pertenece al producto" se repitieron en múltiples componentes.
- Oportunidad: Extraer traits o middleware reutilizables para guardrails comunes.

### 4) Documentación de rutas dispersa

- Las rutas se documentaron en `routes/web.php` pero no hay un inventario centralizado de endpoints.
- Oportunidad: Generar o mantener un archivo de referencia de rutas (o usar `artisan route:list` como artefacto).

## Patrones y lecciones (sintetizado desde Stories 3.1–3.6)

### Patrones recurrentes (buenos)

- **Precarga en `mount()`**: Evitar queries en `render()` mejora rendimiento y previene bugs sutiles.
- **Actions para lógica crítica**: Separar la lógica transaccional de la UI facilita tests y reduce errores.
- **Constantes de dominio**: `Asset::STATUSES`, `Asset::UNAVAILABLE_STATUSES`, etc., evitan strings mágicos.
- **Routing con constraints**: `whereNumber` en rutas evita colisiones y valida inputs temprano.

### Aprendizajes clave

1. **Semántica QTY debe ser explícita y visible**: No depender de suposiciones; definir y documentar desde la primera story.
2. **Tenencia "pendiente" como placeholder**: Mostrar "N/A" explícito evita confusión y fuerza el scope correcto.
3. **Code review adversarial paga rápido**: Hallazgos reales (performance, seguridad, UX) se corrigen antes de merge.
4. **Transacciones para operaciones críticas**: Ajustes de inventario nunca deben dejar datos inconsistentes.

## Seguimiento de retrospectiva anterior (Épica 2)

Se revisaron compromisos de la retrospectiva de Épica 2 (`_bmad-output/implementation-artifacts/epic-2-retro-2026-01-01.md`):

| Action Item | Estado |
|-------------|--------|
| Normalizar "Epic source of truth" para workflows | **Pendiente** (sigue dependiendo de rutas manuales) |
| Checklist estándar de "defensa en profundidad Livewire" | **En práctica** (visible en todas las stories de Épica 3) |
| Consolidar helpers de búsqueda y normalización | **Parcial** (se reutilizan constantes, pero no hay helper transversal) |
| Estrategia de integridad "en uso" para crecimiento del dominio | **Cumplido** (`CatalogUsage` bloquea deletes; FKs reales en productos/activos) |
| Definir y registrar aceptación (PO) por épica | **Pendiente** (no hay sign-off formal en artefactos) |

## Preparación para la próxima épica (Épica 4: Directorio de Empleados)

Según `sprint-status.yaml`, la Épica 4 cubre:

- 4.1 Crear y mantener Empleados (RPE)
- 4.2 Buscar/seleccionar Empleados al registrar movimientos (autocomplete)
- 4.3 Ficha de Empleado (detalle) y activos asociados (si existen)

### Dependencias claras desde Épica 3

- Inventario navegable (Productos/Activos) ya operativo.
- Semántica QTY y estados de Activo consolidados.
- Patrones de RBAC, rutas, y UI listos para reutilizar.

### Riesgos a anticipar para Épica 4

- **Reglas de unicidad de RPE**: Definir si RPE es clave única o combinado con otro identificador.
- **Integración futura con Movimientos (Épica 5)**: Preparar la estructura de `employees` para soportar relaciones con `assets` y movimientos.
- **Autocomplete UX**: Definir comportamiento para nombres/RPE duplicados o parciales.

### Tareas de preparación propuestas (Épica 4) — sin estimaciones

- [ ] Alinear y documentar reglas de unicidad y validación para Empleados (RPE)  
  Owner: Winston (Architect) + Charlie (Senior Dev)
- [ ] Definir estructura base de `employees` (campos mínimos, relaciones con futuras tablas de movimientos)  
  Owner: Winston (Architect)
- [ ] Preparar patrones UX para autocomplete (debounce, mínimo de caracteres, resultados máximos)  
  Owner: Dana (QA Engineer) + Elena (Junior Dev)
- [ ] Confirmar que la sección "Activos asignados/prestados" en la ficha de Empleado se muestre vacía o con placeholder hasta Épica 5  
  Owner: Alice (Product Owner)

## Action Items (compromisos) — sin estimaciones

### Proceso

1) **Normalizar el "Epic source of truth" para workflows** (arrastre de Épica 2)
   - Owner: Bob (Scrum Master) + Paige (Technical Writer)
   - Deadline: Antes de correr el siguiente workflow de retrospectiva / sprint-planning
   - Criterio de éxito: el workflow encuentra el epic actual/siguiente sin depender de rutas manuales

2) **Definir y registrar aceptación (PO) por épica** (arrastre de Épica 2)
   - Owner: Alice (Product Owner) + Carlos (Project Lead)
   - Deadline: Antes de marcar la próxima épica como `done`
   - Criterio de éxito: existe evidencia de demo/revisión y un "sign-off" simple en artefactos

### Técnico

3) **Consolidar helpers/scopes para conteos de disponibilidad**
   - Owner: Charlie (Senior Dev) + Winston (Architect)
   - Deadline: Antes de iniciar Story 4.3 (ficha de Empleado con activos)
   - Criterio de éxito: un único scope/método en `Product` y `Asset` para obtener conteos, usado por listados y detalles

4) **Estandarizar asserts de tests para UI**
   - Owner: Dana (QA Engineer) + Charlie (Senior Dev)
   - Deadline: Antes de cerrar Épica 4
   - Criterio de éxito: nuevos tests usan `assertSeeTextInOrder`/data-attributes en lugar de regex sobre HTML

5) **Extraer traits/middleware para guardrails comunes**
   - Owner: Winston (Architect)
   - Deadline: Antes de iniciar Épica 5 (Movimientos)
   - Criterio de éxito: "producto serializado requerido" y "activo pertenece al producto" son traits/middleware reutilizables

### Producto / Operación

6) **Definir reglas de unicidad y campos mínimos para Empleados (RPE)**
   - Owner: Alice (Product Owner) + Winston (Architect)
   - Deadline: Antes de crear la Story 4.1 "ready-for-dev"
   - Criterio de éxito: reglas documentadas en artefacto y validadas por PO

## Ruta crítica (antes de iniciar Épica 4) — sin estimaciones

1. Reglas de unicidad de Empleados definidas (Action Item #6)
2. Aceptación/validación de la Épica 3 trazada (Action Item #2)
3. Helpers de conteos consolidados si Story 4.3 los requiere (Action Item #3)

## Readiness Assessment (Épica 3)

| Área | Estado |
|------|--------|
| Testing & Quality | ✅ Suite de 136+ tests passing; Pint + PHPStan en verde |
| Deployment | ⚠️ No trazado en artefactos (pendiente: capturar estado de despliegue) |
| Stakeholder/PO Acceptance | ⚠️ No hay sign-off formal (acción: agregar bloque de aceptación) |
| Salud técnica | ✅ Base sólida; patrones consolidados; sin deuda crítica conocida |

## Cierre

La Épica 3 deja un módulo de Inventario navegable completo para Gate 2: Productos y Activos operativos, disponibilidad visible, y ajustes con trazabilidad. Los patrones técnicos (Livewire-first, Actions, RBAC en profundidad) están consolidados y listos para escalar en Épicas 4 y 5.

El principal ajuste a corto plazo es **cerrar las brechas de proceso pendientes de Épica 2** (descubrimiento de épicas para workflows, aceptación PO) y **preparar las reglas de Empleados** antes de arrancar Épica 4.
