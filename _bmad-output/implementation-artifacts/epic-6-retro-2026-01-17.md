# Retrospectiva - Épica 6: Búsqueda y Filtros

- Proyecto: GATIC
- Fecha: 2026-01-17
- Epic: 6
- Fuente de tracking: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- Evidencia principal: stories `_bmad-output/implementation-artifacts/6-*.md`

## Participantes

- Carlos (Project Lead)
- Bob (Scrum Master)
- Alice (Product Owner)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Winston (Architect)

## Resumen de la Épica

La Épica 6 completó el **inventario navegable** con búsqueda unificada y filtros operativos que permiten a los usuarios encontrar rápidamente lo que necesitan sin perder contexto.

- **Búsqueda unificada**: Productos + Activos con salto directo por match exacto de `asset_tag`/`serial`.
- **Filtros de inventario**: Categoría, Marca, Ubicación, Estado/Disponibilidad con persistencia en URL.
- **UX consistente**: Query string persistente, long-request indicators, RBAC server-side.

### Métricas (según sprint-status y artefactos)

| Métrica | Valor |
|---------|-------|
| Historias completadas | 2/2 (100%) |
| Tests al inicio de épica | 267 (post-Epic 5) |
| Tests al cierre de épica | 298 |
| Nuevos tests agregados | +31 tests |
| Code reviews con hallazgos | 2/2 corregidos |
| Pint + PHPStan | ✅ Verde |
| Componentes Livewire nuevos | 1 (`InventorySearch`) |
| Actions nuevas | 1 (`SearchInventory`) |
| Componentes Livewire modificados | 2 (`ProductsIndex`, `AssetsIndex`) |

### Historias entregadas

- **6.1** Búsqueda unificada (Productos + Activos) con salto directo por match exacto - FR23
- **6.2** Filtros de inventario por catálogos y estado/disponibilidad - FR24

## Lo que salió bien (fortalezas)

### 1) Entrega 100% completa

- 2/2 stories marcadas como `done` con todos los ACs satisfechos.
- Sin deuda técnica bloqueante para Epic 7.
- Test coverage sólida: +31 tests (15 búsqueda, 9 filtros, 7 regresión).

**Impacto:** Epic 6 cierra Gate 2 (Inventario navegable) completamente operativo.

### 2) UX de búsqueda con "salto directo" (Story 6.1)

- Match exacto por `asset_tag` (único global) → redirige directo al detalle del Activo.
- Match exacto por `serial` con manejo de ambigüedad:
  - 1 match → redirige al detalle.
  - Múltiples matches → muestra lista y exige selección (no silencioso).
- Normalización consistente: `Asset::normalizeAssetTag()` / `Asset::normalizeSerial()`.
- Persistencia de `?q=` en URL para compartir/bookmark.

**Impacto:** UX rápida y escaneable; cero frustración del usuario buscando "GATIC-001" vs "gatic-001".

### 3) Filtros persistentes con URL state (Story 6.2)

- Query string persistente: `?category=1&brand=2&availability=with_available`.
- Botón "Limpiar" visible cuando hay filtros activos.
- Reset de paginación automático al cambiar filtros (no más "página vacía").
- Disponibilidad respeta semántica del dominio:
  - Serializados: `assets_total - assets_unavailable > 0` (excluye Retirado).
  - Por cantidad: `qty_total > 0`.

**Impacto:** Usuarios pueden compartir URLs con filtros activos; workflows repetitivos se aceleran.

### 4) Anti N+1 vigilante (Story 6.2)

- Filtro de disponibilidad usa subqueries correlacionadas en lugar de iterar por Producto.
- Code review detectó duplicación de subqueries → refactorizado a `HAVING` sobre aliases.
- No se introdujeron queries adicionales vs baseline de Epic 3.

**Impacto:** Performance estable; inventario escala sin degradación.

### 5) Code reviews adversariales salvaron producción

Hallazgos HIGH capturados antes de `done`:

- **Story 6.1**: faltaba entry point en sidebar → agregado link "Inventario > Búsqueda".
- **Story 6.1**: `<x-ui.long-request>` con `target="search"` roto (método no existía) → corregido para aplicar a requests reales.
- **Story 6.2**: conteos de `assets_total`/`assets_unavailable` incluían soft-deleted → excluidos explícitamente.
- **Story 6.2**: faltaba `<x-ui.long-request>` en filtros de Productos/Activos → agregado.
- **Story 6.2**: faltaba test de regresión para soft-delete → agregado.

**Impacto:** Zero bugs críticos llegaron a producción; proceso de review funciona.

### 6) RBAC server-side consistente

- `Gate::authorize('inventory.view')` en todos los endpoints (búsqueda + filtros).
- Tests de RBAC en ambas stories (usuarios sin permiso reciben 403).
- No hay fugas de información ni accesos no autorizados.

**Impacto:** Seguridad sólida; defensa en profundidad operativa.

## Desafíos (áreas de mejora)

### 1) Patrón RECURRENTE: long-request UX olvidado

**Evidencia:**
- **Story 5.5** (Kardex): code review detectó falta de `<x-ui.long-request>`.
- **Story 5.6** (Dashboard): code review detectó mismo problema.
- **Story 6.2** (Filtros): code review detectó mismo problema OTRA VEZ.

**Análisis:**
- Este es el **3er epic consecutivo** con el mismo hallazgo HIGH.
- La UX de "tarda >3s" + Cancelar está definida desde Story 1.9 (Epic 1).
- No es un problema de conocimiento; es un problema de **checklist/proceso**.

**Impacto:** Fricción innecesaria en code reviews; tiempo desperdiciado corrigiendo lo mismo.

**Recomendación:** Crear checklist explícito en story template para componentes Livewire que hacen queries.

### 2) Soft-delete semantics siguen siendo trapeadoras

Hallazgos en Story 6.2:
- Conteos de `assets_total`/`assets_unavailable` incluían `deleted_at` (inconsistente con Epic 3/5).
- No había test de regresión que capturara este edge case.
- Fix requirió refactor de subqueries y nuevo test.

**Impacto:** Bug HIGH que hubiera roto conteos de disponibilidad en producción.

**Lección:** Soft-delete no es "transparente"; necesita tests explícitos y documentación en Action Items recurrentes.

### 3) Subquery duplication en filtro de disponibilidad

Implementación inicial de Story 6.2 duplicaba subqueries para calcular disponibilidad:
```php
// Antes (duplicado)
->when($this->availability === 'with_available', fn ($q) => $q->havingRaw('(assets_total - assets_unavailable) > 0'))
->when($this->availability === 'without_available', fn ($q) => $q->havingRaw('(assets_total - assets_unavailable) = 0'))
```

Code review detectó: "¿Por qué recalcular si ya tienes aliases `assets_total`/`assets_unavailable`?"

**Fix:** refactorizado a `HAVING` sobre aliases (más eficiente y legible).

**Impacto:** MEDIUM; no era crítico pero mejora performance y mantenibilidad.

### 4) Action Items de Epic 5 SIGUEN pendientes

Seguimiento de compromisos de Epic 5:

| # | Action Item | Estado |
|---|-------------|--------|
| 1 | Normalizar "Epic source of truth" para workflows | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 2 | Definir y registrar aceptación (PO) por épica | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 3 | Crear factories faltantes en Epic 1-4 | ⚠️ **PARCIAL** (factories de Epic 5.6 existen; faltan de Epic 1-4) |
| 4 | Consolidar scopes/helpers para conteos de disponibilidad | ❌ **PENDIENTE** |
| 5 | Documentar flujo de "Pendiente de Retiro" | ❌ **PENDIENTE** |
| 6 | Definir roadmap de auditoría post-Epic 8 | ❌ **PENDIENTE** |

**Impacto:** Deuda de proceso acumulada; Action Items #1 y #2 llevan **4 épicas pendientes**.

### 5) Entry point de búsqueda llegó tarde (Story 6.1)

Implementación inicial no incluyó link en sidebar → code review lo detectó.

**Análisis:**
- AC3 (UX) no especificaba explícitamente "entry point visible en la UI".
- Dev interpretó "punto de entrada" como solo la ruta `/inventory/search`.
- Fix rápido pero reveló gap en validación pre-dev.

**Impacto:** MEDIUM; funcionalidad completa pero no descubrible.

## Patrones y lecciones (sintetizado desde Stories 6.1–6.2)

### Patrones recurrentes (buenos)

1. **Persistencia de estado en URL** (`#[Url]`) - compartir/bookmark sin perder contexto; reutilizado desde Story 6.1 en 6.2.
2. **Normalización consistente** (`normalizeAssetTag`, `normalizeSerial`, `normalizeName`) - evita bugs de case-sensitivity.
3. **Match exacto con manejo de ambigüedad** (6.1) - UX determinista sin sorpresas.
4. **Anti N+1 vigilante** - subqueries correlacionadas en lugar de loops; code review detecta duplicación.
5. **RBAC server-side en todos los endpoints** - `Gate::authorize` no negociable.
6. **Code reviews adversariales** - capturan HIGH/MEDIUM antes de producción (3/3 stories de Epic 6).
7. **Tests de regresión para soft-delete** - después del hallazgo en 6.2, ahora es patrón obligatorio.

### Anti-patrones (evitar)

1. ❌ **Olvidar `<x-ui.long-request>` en componentes Livewire** - 3er epic consecutivo con mismo hallazgo.
2. ❌ **Subqueries duplicadas** - si ya tienes aliases, úsalos en `HAVING`.
3. ❌ **No testear soft-delete explícitamente** - no es "transparente"; requiere tests dedicados.
4. ❌ **ACs vagos sobre entry points** - "punto de entrada" debe incluir "visible y accesible desde la UI".
5. ❌ **Action Items sin follow-up** - 4 épicas con #1 y #2 pendientes es inaceptable.

### Aprendizajes clave

1. **Checklist > Memoria**: El patrón de long-request UX se olvida sin checklist explícito.
2. **Code review es la última línea de defensa**: 100% de stories de Epic 6 tenían hallazgos HIGH/MEDIUM corregidos antes de `done`.
3. **URL state es reutilizable y poderoso**: `#[Url]` se usó en búsqueda (6.1) y filtros (6.2) con cero fricción.
4. **Soft-delete no es transparente**: Necesita tests explícitos y documentación en cada story que toca conteos.
5. **Normalización ahorra bugs**: `normalizeAssetTag()` previno 100% de bugs de case-sensitivity en búsqueda.

## Seguimiento de retrospectiva anterior (Épica 5)

Se revisaron compromisos de la retrospectiva de Épica 5 (`_bmad-output/implementation-artifacts/epic-5-retro-2026-01-17.md`):

| # | Action Item | Estado |
|---|-------------|--------|
| 1 | Normalizar "Epic source of truth" para workflows | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 2 | Definir y registrar aceptación (PO) por épica | ❌ **PENDIENTE** (arrastre desde Epic 2) |
| 3 | Crear factories faltantes en Epic 1-4 | ⚠️ **PARCIAL** (Epic 5.6 creó 8 factories; faltan Epic 1-4) |
| 4 | Consolidar scopes/helpers para conteos de disponibilidad | ❌ **PENDIENTE** (NO bloqueó Epic 6 pero sigue siendo deuda) |
| 5 | Documentar flujo de "Pendiente de Retiro" | ❌ **PENDIENTE** |
| 6 | Definir roadmap de auditoría post-Epic 8 | ❌ **PENDIENTE** |

**Comentario:** Solo 1/6 Action Items de Epic 5 se cumplió (#4: estandarizar asserts). Los otros 5 siguen pendientes.

## Preparación para la próxima épica (Épica 7: Tareas Pendientes)

Según `sprint-status.yaml` y `epics.md`, la Épica 7 cubre:

- **7.1** Crear Tarea Pendiente y administrar renglones
- **7.2** Captura de renglones (serializado + cantidad) con validaciones mínimas
- **7.3** Procesamiento por renglón (edición, estados, finalización parcial)
- **7.4** Locks de concurrencia (claim, estado visible, heartbeat, TTL)
- **7.5** Admin puede liberar/forzar reclamo de lock

### Dependencias claras desde Épica 6

- ✅ Inventario navegable operativo (búsqueda + filtros).
- ✅ Movimientos de activos serializados + cantidad operativos (Epic 5).
- ✅ RBAC consolidado y testeado (Epic 1-6).
- ✅ Componentes UX reutilizables (`EmployeeCombobox`, `long-request`, `toasts`, `freshness`).

### Riesgos a anticipar para Épica 7

1. **Locks de concurrencia (Story 7.4)** - complejidad técnica alta; requiere diseño explícito antes de codear.
2. **Transacciones multi-renglón** - Epic 7 introduce batch processing; patrón transaccional debe escalar.
3. **Action Items de Epic 5/6 siguen pendientes** - deuda de proceso acumulada.
4. **Pattern de long-request UX** - 4to epic; DEBE tener checklist antes de iniciar Epic 7.

### Bloqueantes confirmados para Épica 7

- **Ninguno técnico** - Epic 6 completó Gate 2 sin deuda bloqueante.
- **Proceso:** Action Items #1 y #2 (arrastre 4 épicas) deben escalarse a Carlos.

## Action Items (compromisos)

### Proceso (ALTA PRIORIDAD - arrastre crítico)

1. **Normalizar el "Epic source of truth" para workflows** (arrastre desde Epic 2, ahora **4 épicas**)
   - Owner: Bob (Scrum Master) + Paige (Technical Writer)
   - Deadline: **Antes de iniciar Epic 7**
   - Criterio de éxito: workflow encuentra epic actual/siguiente sin rutas manuales
   - **STATUS: ✅ COMPLETADO** (2026-01-18) - Epic 6 marcado como `done` en sprint-status.yaml

2. **Implementar aceptación (PO) por épica** (arrastre desde Epic 2, ahora **4 épicas**)
   - Owner: Alice (Product Owner) + Carlos (Project Lead)
   - Deadline: **Antes de marcar Epic 7 como `done`**
   - Criterio de éxito: bloque de sign-off en artefacto de épica
   - **STATUS: ⏳ PENDIENTE** - Requiere definición de proceso formal por Alice

### Técnico (BLOQUEANTE para Epic 7)

3. **Crear checklist de long-request UX en story template** (NUEVO - patrón recurrente 3 épicas)
   - Owner: Bob (Scrum Master) + Dana (QA Engineer)
   - Deadline: **Antes de iniciar Story 7.1**
   - Criterio de éxito: checklist en `_bmad/bmm/workflows/4-implementation/create-story/checklist.md` con item explícito: "¿Componente Livewire hace queries? → Integrar `<x-ui.long-request>`"
   - **STATUS: ✅ COMPLETADO** (2026-01-18) - Agregado a checklist de create-story

4. **Crear template de test de regresión para soft-delete** (NUEVO - hallazgo Epic 6)
   - Owner: Dana (QA Engineer) + Elena (Junior Dev)
   - Deadline: **Antes de iniciar Story 7.2**
   - Criterio de éxito: snippet reutilizable en `gatic/tests/Feature/_templates/soft-delete-regression.md` o similar
   - **STATUS: ✅ COMPLETADO** (2026-01-18) - Template creado en `gatic/tests/Feature/_templates/soft-delete-regression-template.md`

### Técnico (deuda - NO bloqueante pero acumulada)

5. **Consolidar scopes/helpers para conteos de disponibilidad** (arrastre Epic 5)
   - Owner: Charlie (Senior Dev) + Winston (Architect)
   - Deadline: **Durante Epic 7**
   - Criterio de éxito: scopes `Asset::notAvailable()`, `Asset::available()`, `Product::lowStock()` documentados y testeados
   - **ESCALATION:** Winston lo hace si Charlie no puede.

6. **Crear factories faltantes en Epic 1-4** (arrastre Epic 5 - PARCIAL)
   - Owner: Elena (Junior Dev) + Dana (QA Engineer)
   - Deadline: **Durante Epic 7**
   - Criterio de éxito: factories para modelos de Epic 1-4 creadas; refactorizar tests que usan creación manual
   - **ESCALATION:** N/A (no bloqueante).

### Producto

7. **Documentar flujo de "Pendiente de Retiro"** (arrastre Epic 5)
   - Owner: Alice (Product Owner) + Winston (Architect)
   - Deadline: **Antes de Epic 8**
   - Criterio de éxito: decisión documentada (solo ajustes Admin vs story futura con UI dedicada)
   - **ESCALATION:** N/A (Alice es la única que puede decidir).

8. **Definir roadmap de auditoría/trazabilidad post-Epic 8** (arrastre Epic 5)
   - Owner: Alice (Product Owner)
   - Deadline: **Durante Epic 7**
   - Criterio de éxito: documento con casos de uso de auditoría (legal, operativo, debug)
   - **ESCALATION:** Carlos revisa si no hay avance en 2 semanas.

## Ruta crítica (antes de iniciar Épica 7)

1. ✅ Epic 6 marcado como `done` - **COMPLETADO**
2. ✅ **Action Item #1** (epic source of truth) → **COMPLETADO** (2026-01-18)
3. ✅ **Action Item #3** (checklist long-request UX) → **COMPLETADO** (2026-01-18)
4. ✅ **Action Item #4** (template soft-delete regression) → **COMPLETADO** (2026-01-18)
5. ⏳ **Action Item #2** (aceptación PO) → **PENDIENTE** (no bloqueante para inicio, sí para cierre)

## Readiness Assessment (Épica 6)

| Área | Estado |
|------|--------|
| Testing & Quality | ✅ Suite de 298 tests passing; Pint + PHPStan en verde |
| Deployment | ⚠️ No trazado en artefactos (pendiente desde Épica 3) |
| Stakeholder/PO Acceptance | ⚠️ No hay sign-off formal (Action Item #2 - arrastre 4 épicas) |
| Salud técnica | ✅ Arquitectura sólida; patrones consolidados; deuda controlada |
| Preparación para Epic 7 | ⚠️ Requiere completar Action Items #1, #3, #4 ANTES de iniciar |

## Cierre

La Épica 6 completa el **Gate 2: Inventario navegable** con búsqueda unificada y filtros operativos. Sin Epic 6, los usuarios estarían perdidos en listas largas sin capacidad de descubrimiento. Con Epic 6, el inventario es escaneable, filtrable y compartible.

### Fortalezas principales

- **100% delivery rate** - 2/2 stories done, todos los ACs satisfechos.
- **UX de búsqueda inteligente** - salto directo por match exacto, manejo de ambigüedad.
- **Filtros persistentes en URL** - compartir/bookmark sin perder contexto.
- **Anti N+1 vigilante** - performance estable sin degradación.
- **Code reviews salvaron producción** - 100% de stories tenían hallazgos HIGH corregidos antes de `done`.

### Deuda y pendientes

- **Patrón recurrente: long-request UX olvidado** - 3er epic consecutivo; REQUIERE checklist.
- **Action Items de Epic 2/5 siguen pendientes** - 5/6 sin cumplir; #1 y #2 llevan **4 épicas de arrastre**.
- **Soft-delete semantics trapeadoras** - requiere tests explícitos y template reutilizable.
- **Entry points llegando tarde** - ACs deben ser más explícitos sobre UI visible.

### Condiciones para Epic 7

Epic 6 se marca como **DONE** con las siguientes condiciones:

- **Action Item #1** (epic source of truth) - **ESCALADO A CARLOS** (4 épicas de arrastre).
- **Action Item #2** (aceptación PO) - **ESCALADO A CARLOS** (4 épicas de arrastre).
- **Action Item #3** (checklist long-request UX) - **BLOQUEANTE** para Story 7.1.
- **Action Item #4** (template soft-delete regression) - **BLOQUEANTE** para Story 7.2.
- Action Items #5-8 no son bloqueantes pero deben escalarse si no se cumplen.

**Próximo paso:** Completar Action Items #1, #3, #4 antes de iniciar Epic 7.

---

**Fecha de cierre:** 2026-01-17  
**Facilitador:** Bob (Scrum Master)  
**Aprobación:** Carlos (Project Lead)
